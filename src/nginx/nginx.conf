events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        server_name _;

        # Identity Header
        add_header X-Node-ID "node-generic";

        # Root is the shared volume where SRS writes files
        root /usr/share/nginx/html;

        # CORS
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';

        # Default root handler
        location / {
            # Security: Secure Link Module
            # The SECRET_KEY is injected by entrypoint.sh at runtime
            secure_link $arg_token,$arg_expires;
            secure_link_md5 "$secure_link_expires$uri$remote_addr REPLACE_WITH_SECRET_KEY";

            # Enforce Security (Priority 1)
            # If the link is invalid or expired, return 403 Forbidden or 410 Gone
            if ($secure_link = "") { return 403; }
            if ($secure_link = "0") { return 410; }

            if ($request_method = OPTIONS) {
                return 204;
            }

            types {
                application/dash+xml mpd;
                video/iso.segment m4s;
            }

            # Cache Rules
            location ~ \.m4s$ {
                expires 1y;
                add_header Cache-Control "public, max-age=31536000";
                add_header Access-Control-Allow-Origin *;
            }
            location ~ \.mpd$ {
                expires 5s;
                add_header Cache-Control "public, max-age=5";
                add_header Access-Control-Allow-Origin *;
            }
        }

        # Health Check
        location /health {
            return 200 "OK";
        }
    }
}
