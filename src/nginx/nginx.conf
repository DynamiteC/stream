events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 80;
        server_name _;

        # Identity Header
        # Note: In real deploy, use envsubst to inject the real ID
        add_header X-Node-ID "node-generic";

        # Root is the shared volume where SRS writes files
        root /usr/share/nginx/html;

        # CORS
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';

        location /live {
            # Security: Secure Link Module
            # Uncomment below to enable signature validation
            # secure_link $arg_token,$arg_expires;
            # secure_link_md5 "$secure_link_expires$uri$remote_addr mysecretkey";
            #
            # if ($secure_link = "") { return 403; }
            # if ($secure_link = "0") { return 410; }

            # Simple check for existence
            if ($request_method = OPTIONS) {
                return 204;
            }

            types {
                application/dash+xml mpd;
                video/iso.segment m4s;
            }

            # Cache Rules
            location ~ \.m4s$ {
                expires 1y;
                add_header Cache-Control "public, max-age=31536000";
                add_header Access-Control-Allow-Origin *;
            }
            location ~ \.mpd$ {
                expires 5s;
                add_header Cache-Control "public, max-age=5";
                add_header Access-Control-Allow-Origin *;
            }
        }

        # Health Check
        location /health {
            return 200 "OK";
        }
    }
}
